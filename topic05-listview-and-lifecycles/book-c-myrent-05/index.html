 <!DOCTYPE html>
 <html>
   <head>

     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">

     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/semantic.min.css" type="text/css">
     <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/solarized_light.min.css" rel="stylesheet" />

     <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/semantic.min.js"></script>
     <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script>
     <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

      <style>


body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

figcaption
{
  margin-bottom: 20px;
}

.vertical-align
{
  display: flex;
  align-items: center;
}

.credits
{
  min-height:20px;
}
    </style>

  </head>

  <body>

  <div class="ui container">
<style>


code
{
  font-family: "Monaco";
  font-size: 110%;
}

img
{
  padding:1px;
  border:1px solid black;
}

h1
{
  font-style:italic;
  font-size:130%;
  border-bottom: thin solid black;
}
h2
{
  font-size:110%;
  border-bottom: thin solid black;
}
h3
{
  font-size:100%;
  border-bottom: thin solid black;
}

</style>

<div class="ui fixed top pointing inverted menu labmenu">
  <header class="header item">
    <a href="../index.html">
      <i class="sitemap icon"></i>
      Listview & Lifecycles
    </a>
  </header>
  <div class="right tab-menu menu">
    <a class="active item" data-tab="MyRent-05">
        MyRent-05
    </a>
      <a class="item" data-tab="01">
        01
      </a>
      <a class="item" data-tab="02">
        02
      </a>
      <a class="item" data-tab="03">
        03
      </a>
      <a class="item" data-tab="04">
        04
      </a>
      <a class="item" data-tab="05">
        05
      </a>
    </div>
</div>

<br><br>

  <div  class="ui tab segment lab" data-tab="MyRent-05">
    <h1>Contact list &amp; Email support</h1>
<p>Activities within an application can reach out to activities in other applications to perform specific tasks. In this lab we introduce two new features - selecting a contact from the phone's contact lists, and sending an email to the selected user. Both of these features require the use of 'implicit' intents.</p>
  </div>
  <div  class="ui tab segment lab" data-tab="01">
    <h1>Resources</h1>
<p>Continue building the MyRent app that you developed in the previous lab.</p>
<p>For reference, we are providing a version here of the completed MyRent-03:</p>
<pre><code>git clone https://github.com/wit-computing/myrent-04.git
</code></pre>

<p>In preparing for our new features, we define some strings to be used by the application. This step is not strictly necessary - but taking this approach is considered best practice, and enables the application to be internationalized more easily.</p>
<p>These are the new strings:</p>
<h2>res/strings.xml</h2>
<pre><code>  &lt;string name=&quot;landlord&quot;&gt;Prospective Tenant&lt;/string&gt;
  &lt;string name=&quot;residence_report&quot;&gt;Send Residence Information&lt;/string&gt;

  &lt;string name=&quot;residence_report_rented&quot;&gt;The residence is already let.&lt;/string&gt;
  &lt;string name=&quot;residence_report_not_rented&quot;&gt;The residence is still available.&lt;/string&gt;
  &lt;string name=&quot;residence_report_nobody_interested&quot;&gt;There is no other prospective tenant at this time.&lt;/string&gt;
  &lt;string name=&quot;residence_report_prospective_tenant&quot;&gt;The prospective tenant is %s.&lt;/string&gt;
  &lt;string name=&quot;residence_report_subject&quot;&gt;Status Report on Residence Availability&lt;/string&gt;
  &lt;string name=&quot;send_report&quot;&gt;Send residence report via&lt;/string&gt;   
</code></pre>

<p>We need 2 new buttons which will enable the user to select a contact, and send an email:</p>
<p><img alt="Figure 1: Prospective Tenant &amp; Send Residence Information Buttons added" src="img/01.png"></p>
<p>These are the button characteristics:</p>
<h2>res/layout/activity_residence.xml</h2>
<pre><code>    &lt;Button
        android:id=&quot;@+id/tenant&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:layout_marginLeft=&quot;16dp&quot;
        android:layout_marginRight=&quot;16dp&quot;
        android:text=&quot;@string/landlord&quot; /&gt;  

    &lt;Button android:id=&quot;@+id/residence_reportButton&quot;
          android:layout_width=&quot;match_parent&quot;
          android:layout_height=&quot;wrap_content&quot;
          android:layout_marginLeft=&quot;16dp&quot;
          android:layout_marginRight=&quot;16dp&quot;
          android:text=&quot;@string/residence_report&quot;
        /&gt; 
</code></pre>
  </div>
  <div  class="ui tab segment lab" data-tab="02">
    <h1>Helpers</h1>
<p>Our IntentHelper class is a useful location for methods that involved intents, either explicit or implicit. Here we introduce two new methods to trigger contact list and email access:</p>
<h2>IntentHelper</h2>
<pre><code>  public static void selectContact(Activity parent, int id)
  {
    Intent selectContactIntent = new Intent(Intent.ACTION_PICK, ContactsContract.Contacts.CONTENT_URI);
    parent.startActivityForResult(selectContactIntent, id);
  }

  public static void sendEmail(Context context, String email, String subject, String body)
  {
    Intent emailIntent = new Intent(Intent.ACTION_SENDTO, Uri.fromParts(&quot;mailto&quot;, email, null));
    emailIntent.putExtra(Intent.EXTRA_SUBJECT, subject);
    emailIntent.putExtra(Intent.EXTRA_TEXT, body);
    context.startActivity(Intent.createChooser(emailIntent, &quot;Sending Email&quot;));
  }
</code></pre>

<p>The import statements for the above:</p>
<pre><code>import android.provider.ContactsContract;
import android.content.Context;
import android.net.Uri;
</code></pre>

<p>We will make use of these in the next step.</p>
<h2>ContactHelper</h2>
<p>Accessing the phone's contact list an be complex, requiring us to engage with the 'Content Provider' API for the Contact List. Having this awkward code in our activities can make them hard to read - so we resort to another helper:</p>
<pre><code>package org.wit.android.helpers;

import android.content.Context;
import android.content.Intent;
import android.database.Cursor;
import android.net.Uri;
import android.provider.ContactsContract;
import android.content.ContentResolver;


public class ContactHelper
{ 
  public static String getDisplayName(Context context, Intent data)
  {
    String contact = &quot;unable to find contact&quot;;
    Uri contactUri = data.getData();
    String[] queryFields = new String[] { ContactsContract.Contacts.DISPLAY_NAME };
    Cursor c = context.getContentResolver().query(contactUri, queryFields, null, null, null);
    if (c.getCount() == 0)
    {
      c.close();
      return contact;
    }
    c.moveToFirst();
    contact = c.getString(0);
    c.close();

    return contact;
  }

  public static String getEmail(Context context, Intent data)
  {
    String email = &quot;no email&quot;;

    Uri contactUri = data.getData();
    ContentResolver cr = context.getContentResolver();

    Cursor cur = cr.query(contactUri, null, null, null, null);

    if (cur.getCount() &gt; 0)
    {
      try
      {
        cur.moveToFirst();
        String contactId = cur.getString(cur.getColumnIndex(ContactsContract.Contacts._ID));
        Cursor emails = cr.query(ContactsContract.CommonDataKinds.Email.CONTENT_URI, null,
            ContactsContract.CommonDataKinds.Email.CONTACT_ID + &quot; = &quot; + contactId, null, null);
        emails.moveToFirst();
        email = emails.getString(emails.getColumnIndex(ContactsContract.CommonDataKinds.Email.DATA));
        emails.close();
      }
      catch (Exception e)
      {
      }
    }
    return email;
  }

  public static String getContact(Context context, Intent data)
  {
    String contact = &quot;unable to find contact&quot;;
    Uri contactUri = data.getData();
    String[] queryFields = new String[] { ContactsContract.Contacts.DISPLAY_NAME };
    Cursor c = context.getContentResolver().query(contactUri, queryFields, null, null, null);
    if (c.getCount() == 0)
    {
      c.close();
      return contact;
    }
    c.moveToFirst();
    contact = c.getString(0);
    c.close();

    return contact;
  }
}
</code></pre>

<p>The above is fairly crudely implemented - we can either get uses 'Diaplay Name' or their 'Email' - but not both.</p>
<p>The second method - getting an email - will require explicit permission to acccess the detail in a contact. otherwise it will fail. In the manifest, introduce the following before the application element:</p>
<pre><code>    &lt;uses-permission android:name=&quot;android.permission.READ_CONTACTS&quot; /&gt;
</code></pre>
  </div>
  <div  class="ui tab segment lab" data-tab="03">
    <h1>Residence</h1>
<p>The Residence model class will need to be extended to include a new field (the tenant) and also a new method, one to generate a report. First introduce these imports:</p>
<pre><code>import org.wit.myrent.R;
import android.content.Context;
</code></pre>

<p>This is the new field:</p>
<pre><code>public String  tenant;
</code></pre>

<p>Initialize this in the default constructor with a String literal to avoid a future null pointer exception error:</p>
<pre><code>  public Residence()
  {
    ...
    ...
    tenant      = &quot;: none presently&quot;;
  }
</code></pre>

<p>We will also dispence with the <em>this</em> reference in the Residence constructor as there are no arguments and thus no need to difference between similarly named local variables (actual parameters) and instance variables:</p>
<pre><code>  public Residence()
  {
    id          = UUID.randomUUID();
    date        = new Date();
    geolocation = &quot;52.253456,-7.187162&quot;;
    tenant      = &quot;: none presently&quot;;
  }
</code></pre>

<p>To keep serialization on track - add an identifier for this new field:</p>
<pre><code>  private static final String JSON_TENANT         = &quot;tenant&quot;;  
</code></pre>

<p>... which will need to be engaged in the overloaded constructor:</p>
<pre><code>  public Residence(JSONObject json) throws JSONException
  {
    ...
    ...
    tenant        = json.getString(JSON_TENANT);
  }
</code></pre>

<p>... and the serialization itself:</p>
<pre><code>    json.put(JSON_TENANT        , tenant);
</code></pre>

<p>Finally, a new method to generate the contents of the email:</p>
<pre><code>  public String getResidenceReport(Context context)
  {
    String rentedString = null;
    if (rented)
    {
      rentedString = context.getString(R.string.residence_report_rented);
    }
    else
    {
      rentedString = context.getString(R.string.residence_report_not_rented);
    }
    String dateFormat = &quot;EEE, MMM dd&quot;;
    String dateString = android.text.format.DateFormat.format(dateFormat, date).toString();
    String prospectiveTenant = tenant;
    if (tenant == null)
    {
      prospectiveTenant = context.getString(R.string.residence_report_nobody_interested);
    }
    else
    {
      prospectiveTenant = context.getString(R.string.residence_report_prospective_tenant, tenant);
    }
    String report =  &quot;Location &quot; + geolocation + &quot; Date: &quot; + dateString + &quot; &quot; + rentedString + &quot; &quot; + prospectiveTenant;
    return report;
  }
</code></pre>
  </div>
  <div  class="ui tab segment lab" data-tab="04">
    <h1>ResidenceActivity - Tenant</h1>
<p>We can then start to wire up a "Prospective Tenant" button.</p>
<p>The imports:</p>
<pre><code>import static org.wit.android.helpers.ContactHelper.getContact;
import static org.wit.android.helpers.IntentHelper.selectContact;
import android.content.Intent;
</code></pre>

<p>An ID we will use for the implicit Intent:</p>
<pre><code>private static final int REQUEST_CONTACT = 1;
</code></pre>

<p>The button to trigger the intent:</p>
<pre><code>private Button   tenantButton;
</code></pre>

<p>Initialization in <em>onCreate</em> of the button:</p>
<pre><code>tenantButton = (Button)   findViewById(R.id.tenant);
</code></pre>

<p>Its event handler set up in <em>updateControls</em>:</p>
<pre><code>tenantButton.setOnClickListener(this);
</code></pre>

<p>And then the event handler itself:</p>
<pre><code>  @Override
  public void onClick(View v)
  {
    switch (v.getId())
    {
      //...

      case R.id.tenant                 : selectContact(this, REQUEST_CONTACT);
                                         break;                                       
    }
  }
</code></pre>

<p>This last method will trigger a 'startActivityForResult' - which we will have to deal with in order to recover the actual contact. This will be provided by the following new method (for which an import statement that follows is required):</p>
<pre><code>  @Override
  public void onActivityResult(int requestCode, int resultCode, Intent data)
  {
    switch (requestCode)
    {
      case REQUEST_CONTACT    : String name= getContact(this, data);
                                residence.tenant = name;
                                tenantButton.setText(name);      
                                break;
    }
  }  
</code></pre>

<pre><code>import static org.wit.android.helpers.ContactHelper.getContact;

</code></pre>

<p>Note that the above passes the data we received from the Contact List activity to our helper, which will recover the actual email address.</p>
<p>Test as follows:</p>
<ul>
<li>build and install the app on an emulator or device, </li>
<li>create a residence </li>
<li>press the Prospective Tenant button. You should be taken to your contact list. </li>
<li>select a contact. This should return you to the MyRent Residence Activity screen. The contact name should be present on the button as shown in Figure 1.</li>
</ul>
<p>Warning: an issue exists which may be reproduced by pressing the Prospective Tenant button and immediately pressing the back button but without chosing a contact.</p>
  </div>
  <div  class="ui tab segment lab" data-tab="05">
    <h1>ResidenceActivity - Email</h1>
<p>Now we can engage the report button to actually send the email.</p>
<p>The imports:</p>
<pre><code>import static org.wit.android.helpers.IntentHelper.sendEmail;
</code></pre>

<p>The Button object:</p>
<pre><code>private Button   reportButton;
</code></pre>

<p>Initialisation of the button:</p>
<pre><code>reportButton = (Button)   findViewById(R.id.residence_reportButton);
</code></pre>

<p>Enabling the event handler:</p>
<pre><code>reportButton.setOnClickListener(this);
</code></pre>

<p>The event handler itself:</p>
<pre><code>  @Override
  public void onClick(View v)
  {
    switch (v.getId())
    {
      //...

      case R.id.residence_reportButton : sendEmail(this, &quot;&quot;, getString(R.string.residence_report_subject), residence.getResidenceReport(this));                           
                                         break;                                         
    }
  }
</code></pre>

<p>Test this now. Make sure the contact you select actually has an email address in the contact info.</p>
<p>If gmail is the default mail handling app, it may look like this:</p>
<p><img alt="Figure 1: Sample Email" src="img/02.png"></p>
  </div>
<script>
$('.ui.menu .item')
  .tab({
    history: true,
    historyType: 'hash'
  })
;
</script>
   </div>



  <br><br>
  <div class="ui bottom fixed borderless menu">
    <div class="ui small item">
    <p id="footertext">
    Prepared by  Eamonn de Leastar (edeleastar@tssg.wit.ie) & John Fitzgerald (johnjfitzgerald@outlook.com). Except where otherwise noted, this content is licensed under a
     <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/"
       target="_blank">Creative Commons Attribution-NonCommercial 4.0 License
     </a>
     </p>
    </div>
  </div>    <script>

$(document).ready(function()
{
  $("img").addClass ("ui image");

  var images = $(".lab img");
  jQuery.each(images, function(i)  {
    if((images[i].alt).length > 0)
    {
      var div_img = $(document.createElement("div")).addClass("ui segment");
      $(images[i]).wrap(div_img);
      var div_label = $(document.createElement("div")).addClass("ui ribbon teal top attached label");
      div_label.append(images[i].alt);
      $(div_label).insertBefore(images[i]);
    }
  });
})    </script>

  </body>
 </html>