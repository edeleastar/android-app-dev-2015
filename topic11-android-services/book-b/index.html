 <!DOCTYPE html>
 <html>
   <head>

     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">

     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/semantic.min.css" type="text/css">
     <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/solarized_light.min.css" rel="stylesheet" />

     <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/semantic.min.js"></script>
     <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
     <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

      <style>


body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

figcaption
{
  margin-bottom: 20px;
}

.vertical-align
{
  display: flex;
  align-items: center;
}

.credits
{
  min-height:20px;
}
    </style>

  </head>

  <body>

  <div class="ui container">
<style>


code
{
  font-family: "Monaco";
  font-size: 110%;
}

img
{
  padding:1px;
  border:1px solid black;
}

h1
{
  font-style:italic;
  font-size:130%;
  border-bottom: thin solid black;
}
h2
{
  font-size:110%;
  border-bottom: thin solid black;
}
h3
{
  font-size:100%;
  border-bottom: thin solid black;
}

</style>

<div class="ui fixed top pointing inverted menu labmenu">
  <header class="header item">
    <a href="../index.html">
      <i class="sitemap icon"></i>
      Android Services
    </a>
  </header>
  <div class="right tab-menu menu">
    <a class="active item" data-tab="05">
        05
    </a>
      <a class="item" data-tab="06">
        06
      </a>
      <a class="item" data-tab="09">
        09
      </a>
    </div>
</div>

<br><br>

  <div  class="ui tab segment lab" data-tab="05">
    <h1>RefreshService</h1>
<p>Here we shall create RefreshService, a subclass of Android's <a href="http://developer.android.com/reference/android/app/IntentService.html">IntentService</a>.</p>
<p>Create a package <em>app.donation.services</em>.</p>
<p>In this package create a new class, RefreshService that subclasses IntentService:</p>
<pre><code>package app.donation.services;

public class RefreshService extends IntentService
{
  private String tag = &quot;Donation&quot;;
  DonationApp app;

  public RefeshService()
  {
    super(&quot;RefreshService&quot;);

  }
}
</code></pre>

<p>Add an import statement for IntentService:</p>
<pre><code>import android.app.IntentService;
</code></pre>

<p>Add unimplemented method:</p>
<pre><code>  @Override
  protected void onHandleIntent(Intent intent)
  {
    // TODO Auto-generated method stub

  }
</code></pre>

<p>An import for Intent is required:</p>
<pre><code>import android.content.Intent;
</code></pre>

<p>The code should now be error free.</p>
<p>The method <em>onHandleIntent</em> runs on a worker thread once an instance of RefreshService is started. </p>
<ul>
<li>when the method has been executed the service automatically stops.</li>
</ul>
<p>In onHandleIntent we shall:</p>
<ul>
<li>Obtain a reference to DonationApp,</li>
<li>Create an Intent for broadcast,</li>
<li>Make a synchonous network call to retrieve the list of donations,</li>
<li>Save the list to DonationApp,</li>
<li>Broadcast the intent.</li>
</ul>
<pre><code>  @Override
  protected void onHandleIntent(Intent intent)
  {
    app = (DonationApp) getApplication();
    Intent localIntent = new Intent(Report.BROADCAST_ACTION);
    Call&lt;List&lt;Donation&gt;&gt; call = (Call&lt;List&lt;Donation&gt;&gt;) app.donationService.getAllDonations();
    try
    {
      Response&lt;List&lt;Donation&gt;&gt; response = call.execute();
      app.donations = response.body();
      LocalBroadcastManager.getInstance(this).sendBroadcast(localIntent);
    }
    catch (IOException e)
    {
      LogHelpers.info(tag, &quot;Failed to retrieve donations list - network error&quot;);
    }
  }
</code></pre>

<p>Add an onDestroy method, soley for the purpose of creating a log entry:</p>
<pre><code>  @Override
  public void onDestroy()
  {
    super.onDestroy();
    LogHelpers.info(this, &quot;onDestroyed&quot;);
  }
</code></pre>

<p>For reference, here is the complete class:</p>
<pre><code>package app.donation.services;

import android.app.IntentService;
import android.content.Intent;
import android.support.v4.content.LocalBroadcastManager;

import java.io.IOException;
import java.util.List;

import app.android.helpers.LogHelpers;
import app.donation.activity.Report;
import app.donation.main.DonationApp;
import app.donation.model.Donation;
import retrofit.Call;
import retrofit.Response;

public class RefreshService extends IntentService
{
  private String tag = &quot;Donation&quot;;
  DonationApp app;
  public RefreshService()
  {
    super(&quot;RefreshService&quot;);
  }

  @Override
  protected void onHandleIntent(Intent intent)
  {
    app = (DonationApp) getApplication();
    Intent localIntent = new Intent(Report.BROADCAST_ACTION);
    Call&lt;List&lt;Donation&gt;&gt; call = (Call&lt;List&lt;Donation&gt;&gt;) app.donationService.getAllDonations();
    try
    {
      Response&lt;List&lt;Donation&gt;&gt; response = call.execute();
      app.donations = response.body();
      LocalBroadcastManager.getInstance(this).sendBroadcast(localIntent);
    }
    catch (IOException e)
    {
      LogHelpers.info(tag, &quot;Failed to retrieve donations list - network error&quot;);
    }
  }

  @Override
  public void onDestroy()
  {
    super.onDestroy();
    LogHelpers.info(tag, &quot;RefreshService instance destroyed&quot;);
  }

}
</code></pre>
  </div>
  <div  class="ui tab segment lab" data-tab="06">
    <h1>Receiver</h1>
<p>In this step we shall configure Report activity to receive and respond to an Intent broadcast from the RefreshService implemented in the previous step.</p>
<p>The steps required are:</p>
<ul>
<li>Declare the string variable BROADCAST_ACTION, referenced in the broadcasted Intent.</li>
<li>Register the broadcast receiver.</li>
<li>Define an inner class, <em>ResponseReceiver</em> whose parent is <a href="http://developer.android.com/reference/android/content/BroadcastReceiver.html">BroadCastReceiver</a> and implement its <em>onReceive</em> method.</li>
</ul>
<p>Here is the code related to above that should be inserted in the appropriate locations in Report.java.</p>
<pre><code>  public static final String BROADCAST_ACTION = &quot;app.donation.activity.Report&quot;;

</code></pre>

<p>Register broadcast receiver:</p>
<pre><code>  private IntentFilter intentFilter;
</code></pre>

<p>In onCreate:</p>
<pre><code>    intentFilter = new IntentFilter(BROADCAST_ACTION);
    registerBroadcastReceiver(intentFilter);
</code></pre>

<pre><code>  private void registerBroadcastReceiver(IntentFilter intentFilter)
  {
    ResponseReceiver responseReceiver = new ResponseReceiver();
    LocalBroadcastManager.getInstance(this).registerReceiver(responseReceiver, intentFilter);
  }
</code></pre>

<p>Inner class:</p>
<pre><code>  //Broadcast receiver for receiving status updates from the IntentService
  private class ResponseReceiver extends BroadcastReceiver
  {
    // Called when the BroadcastReceiver gets an Intent it's registered to receive
    @Override
    public void onReceive(Context context, Intent intent)
    {
      adapter.donations = app.donations;
      adapter.notifyDataSetChanged();
    }
  }
</code></pre>

<p>Report activity is now receptive to in coming intents broadcasted by the RefreshService.</p>
<p>However, we still have not taken steps to start the RefreshService. This we shall do in the following step.</p>
<p><img alt="Figure 1: Inner ResponseReceiver class" src="img/03.png"></p>
  </div>
  <div  class="ui tab segment lab" data-tab="09">
    <h1>Receiver</h1>
<p>We shall now add a BroadcastReceiver subclass that will:</p>
<ul>
<li>start RefreshService when the device is started</li>
<li>re-start the service at pre-set intervals thereafter</li>
</ul>
<p>For the moment we will accept the default interval between refreshes. This is 15 minutes.</p>
<p>We have already introduced preferences and a facility for the user to input a refresh interval.</p>
<p>Create a new package <em>app.donation.receivers</em></p>
<ul>
<li>In the package create a class <em>BootReceiver</em> that subclasses the Android class BroadcastReceiver.</li>
</ul>
<pre><code>package app.donation.receivers;
import android.content.BroadcastReceiver;

public class BootReceiver extends BroadcastReceiver
{
  private String tag = &quot;Donation&quot;;


}
</code></pre>

<p>Add unimplemented method:</p>
<pre><code>  @Override
  public void onReceive(Context context, Intent intent)
  {
    // TODO Auto-generated method stub

  }
</code></pre>

<p>Implement <em>onReceive</em> as follows:</p>
<pre><code>  @Override
  public void onReceive(Context context, Intent intent)
  {

    Log.i(tag, &quot;In BootReceiver.onReceive&quot;);

    long interval = DEFAULT_INTERVAL;
    PendingIntent operation = PendingIntent.getService(context, -1, new Intent(context, RefreshService.class),
        PendingIntent.FLAG_UPDATE_CURRENT);

    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);

    if (interval == 0)
    {
      alarmManager.cancel(operation);
      LogHelpers.info(this, &quot;cancelling operation&quot;);
    }
    else
    {
      alarmManager.setInexactRepeating(AlarmManager.RTC, System.currentTimeMillis(), interval, operation);
      LogHelpers.info(this, &quot;setting repeat operation for: &quot; + interval);
    }
    LogHelpers.info(this, &quot;onReceived&quot;);

  }
</code></pre>

<p>Define the DEFAULT_INTERVAL:</p>
<pre><code>private static final long DEFAULT_INTERVAL = AlarmManager.INTERVAL_FIFTEEN_MINUTES;
</code></pre>

<p>Observe RefreshService intent argument in <a href="http://developer.android.com/reference/android/app/PendingIntent.html#getService%28android.content.Context,%20int,%20android.content.Intent,%20int%29">PendingIntent.getService</a>:</p>
<p><img alt="" src="img/04.png"></p>
<p><em>onReceive</em> creates an AlarmManager object that is used in starting the RefreshService at intervals of, in this case, DEFAULT_INTERVAL.</p>
<p>Add permission to the manifest file:</p>
<pre><code>  &lt;uses-permission android:name=&quot;android.permission.RECEIVE_BOOT_COMPLETED&quot; /&gt;
</code></pre>

<p>Also in the manifest, register the receiver:</p>
<pre><code>        &lt;receiver android:name=&quot;.receivers.BootReceiver&quot;
                  android:enabled=&quot;true&quot;&gt;
            &lt;intent-filter &gt;
                &lt;action android:name=&quot;android.intent.action.BOOT_COMPLETED&quot;/&gt;
            &lt;/intent-filter&gt;
        &lt;/receiver&gt;
</code></pre>

<p>The refresh service will start on boot the Android device and re-start indefinitely at specified intervals thereafter.</p>
<p>Good alarm system design is essential to efficient running of an app and use of resources. Some official documentation may be accessed <a href="https://developer.android.com/training/scheduling/alarms.html">here</a>. </p>
<p>Here we make use of Preferences and the refresh frequency input by the user:</p>
<p>Refactor BootReceiver.onReceive to use the value input in preferences for the refresh interval. </p>
<ul>
<li>We are not obligated to input this value as the default 15 minutes will be used if no value has been input in preferences.</li>
<li>In reality 15 minutes would, perhaps, be much too small an interval. Remember that network traffic is expensive not only on the client but generally more so on the server. See, for example, this Wikipedia article on <a href="http://en.wikipedia.org/wiki/Denial-of-service_attack">Denial-of-service attacks</a>.</li>
<li>The input value should be in minutes: this is converted to milliseconds in the onReceive method which is the unit of time specified as argument in AlarmManager.setInexactRepeating.</li>
</ul>
<pre><code>package app.donation.receivers;
import android.app.AlarmManager;
import android.app.PendingIntent;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.helpers.LogHelpers;
import android.preference.PreferenceManager;
import app.donation.services.RefreshService;

public class BootReceiver extends BroadcastReceiver
{
  private String tag = &quot;DONATION_SERVICE&quot;;

  public static int REQUESTCODE = -1;
  private static final long DEFAULT_INTERVAL = AlarmManager.INTERVAL_FIFTEEN_MINUTES;

  @Override
  public void onReceive(Context context, Intent intent)
  {

    Log.i(tag, &quot;In BootReceiver.onReceive&quot;);

    SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(context);
    long interval = Long.parseLong(prefs.getString(&quot;refresh_interval&quot;, Long.toString(DEFAULT_INTERVAL)));
    interval *= 60000;//here we convert minutes to milliseconds since input at settings menu is specified in minutes
    interval = interval &lt; 60000 ? 60000 : interval; //Think of the poor server. Denial of service? So we set 60 seconds as the minimum
    PendingIntent operation = PendingIntent.getService(context, REQUESTCODE, new Intent(context, RefreshService.class),
        PendingIntent.FLAG_UPDATE_CURRENT);

    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);
    alarmManager.cancel(operation);//cancel any existing alarms with matching intent
    alarmManager.setInexactRepeating(AlarmManager.RTC, System.currentTimeMillis(), interval, operation);
    LogHelpers.info(this, &quot;setting repeat operation for: &quot; + interval);
    LogHelpers.info(this, &quot;onReceived&quot;);    
  }

}
</code></pre>

<p>You can now test this code as follows:</p>
<ul>
<li>Comment out the invocation of the refreshDonationList() method in DonationApp.</li>
<li>Set the LogCat filter to DONATION_SERVICE.</li>
<li>Build and install Donation on a device (emulator).</li>
<li>Shut down and reboot the device (phone or emulator).</li>
<li>Manually start the already installed Donation app.</li>
<li>Authenticate and navigate to Report view. </li>
<li>Set the refresh interval to 1 (minute) in the settings.</li>
<li>Wait. After a short period of time the blank Report view should be populated with the updated list of donations.</li>
<li>The LogCat view should show a message something like this:
<img alt="" src="img/06.png"></li>
</ul>
  </div>
<script>
$('.ui.menu .item')
  .tab({
    history: true,
    historyType: 'hash'
  })
;
</script>
   </div>



  <br><br>
  <div class="ui bottom fixed borderless menu">
    <div class="ui small item">
    <p id="footertext">
    Prepared by  Eamonn de Leastar (edeleastar@tssg.wit.ie) & John Fitzgerald (johnjfitzgerald@outlook.com). Except where otherwise noted, this content is licensed under a
     <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/"
       target="_blank">Creative Commons Attribution-NonCommercial 4.0 License
     </a>
     </p>
    </div>
  </div>    <script>

$(document).ready(function()
{
  $("img").addClass ("ui image");

  var images = $(".lab img");
  jQuery.each(images, function(i)  {
    if((images[i].alt).length > 0)
    {
      var div_img = $(document.createElement("div")).addClass("ui segment");
      $(images[i]).wrap(div_img);
      var div_label = $(document.createElement("div")).addClass("ui ribbon teal top attached label");
      div_label.append(images[i].alt);
      $(div_label).insertBefore(images[i]);
    }
  });
})    </script>

  </body>
 </html>